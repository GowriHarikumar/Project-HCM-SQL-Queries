SELECT 
	DISTINCT 
	PAPF.PERSON_NUMBER "EMPLOYEE_NUMBER",
	PAPF.PERSON_ID,
	PPNF.DISPLAY_NAME "EMP_NAME",
	TO_CHAR(SYSDATE,'ddth Mon yyyy','NLS_DATE_LANGUAGE=ENGLISH') REPORT_DATE,
    TO_CHAR(SYSDATE,'YYYY') REPORT_YEAR,
		   ( 
				SELECT 
					HAP.NAME
				FROM
					HR_ALL_POSITIONS HAP
				WHERE
					PAAM.POSITION_ID = HAP.POSITION_ID (+) 
					AND ROWNUM = 1
			) "DESIGNATION",
	TO_CHAR(PAPF.START_DATE, 'DD-MON-YYYY') "DATE_OF_JOINING",
	to_char(lst.LAST_WORKING_DATE,'DD-MM-YYYY') LAST_WORKING_DATE,

	(SELECT
	 DISTINCT FLV.MEANING
	FROM FND_LOOKUP_VALUES FLV
	WHERE FLV.LOOKUP_CODE(+) = NVL(PL.COUNTRY,PAAM.LEGISLATION_CODE)
	AND FLV.LOOKUP_TYPE = 'HZ_DOMAIN_SUFFIX_LIST'
	AND ROWNUM =1) COUNTRY,
	HAOUFB1.NAME "BUSINESS_UNIT",
	XLE.NAME "LEGAL_ENTITY",	
		
		
		APPROVAL.APPROVER_COMPANY,
		APPROVAL.APPROVER_DESIGNATION,
		APPROVAL.APPROVER_SIGNATORY

	FROM
	PER_PERSON_NAMES_F PPNF,
	PER_ALL_PEOPLE_F PAPF,
	PER_ALL_ASSIGNMENTS_M PAAM,
	PER_LOCATIONS PL,
	PER_PERIODS_OF_SERVICE PPOS,
	 (SELECT 
	 person_ID
	 ,MAX(TRUNC(ACTUAL_TERMINATION_DATE)) LAST_WORKING_DATE
	FROM 
	PER_PERIODS_OF_SERVICE
	group by 
	PERson_ID
	) lst,

	HR_ORG_UNIT_CLASSIFICATIONS_F HOUCF,
	HR_ALL_ORGANIZATION_UNITS_VL HAOUF,
	HR_ORG_UNIT_CLASSIFICATIONS_F HOUCFB1,
	HR_ALL_ORGANIZATION_UNITS_VL HAOUFB1,
	XLE_ENTITY_PROFILES XLE,
	HR_LEGAL_ENTITIES HLE,
	(
	SELECT 
	PAPF.PERSON_NUMBER APPROVER_NUMBER,
	FUR.ROW_LOW_RANGE_OR_NAME LEGAL_ENTITY,
	PPNF.DISPLAY_NAME APPROVER_NAME,
	FDT.DM_VERSION_NUMBER DOCUMENT_ID,
	FDT.DM_DOCUMENT_ID UCMFILE,
	HPB.DEI_ATTRIBUTE31 APPROVER_SIGNATORY,
	HAOUF.NAME APPROVER_COMPANY,
	HAP.NAME APPROVER_DESIGNATION

	FROM FF_USER_TABLES FUT,
	FF_USER_COLUMNS FUC,
	FF_USER_COLUMNS_TL FUCT,
	FF_USER_ROWS_F FUR,
	FF_USER_COLUMN_INSTANCES_F FUCI,
	PER_ALL_PEOPLE_F PAPF,
	PER_ALL_ASSIGNMENTS_M PAAM,
	PER_PERSON_NAMES_F PPNF,
	HR_ALL_POSITIONS HAP,
	HR_DOCUMENTS_OF_RECORD HPB,
	HR_DOCUMENT_TYPES_TL HDTL,
	FND_ATTACHED_DOCUMENTS FAD,
	FND_DOCUMENTS_TL FDT,
	HR_ORG_UNIT_CLASSIFICATIONS_F HOUCF,
	HR_ALL_ORGANIZATION_UNITS_VL HAOUF

	WHERE FUT.USER_TABLE_ID = FUC.USER_TABLE_ID 
	AND FUC.USER_COLUMN_ID = FUCT.USER_COLUMN_ID
	AND FUT.USER_TABLE_ID = FUR.USER_TABLE_ID
	AND FUC.USER_COLUMN_ID = FUCI.USER_COLUMN_ID
	AND FUR.USER_ROW_ID = FUCI.USER_ROW_ID
	AND FUT.BASE_USER_TABLE_NAME ='ALS_SIGNATORIES'
	AND FUCI.VALUE = PAPF.PERSON_NUMBER
	AND PAPF.PERSON_ID = PAAM.PERSON_ID
	AND HPB.PERSON_ID = PAPF.PERSON_ID
	AND PAPF.PERSON_ID = PPNF.PERSON_ID
	AND TRUNC(SYSDATE) BETWEEN PAAM.EFFECTIVE_START_DATE AND PAAM.EFFECTIVE_END_DATE
	AND PAAM.ASSIGNMENT_STATUS_TYPE = 'ACTIVE'
	AND PAAM.EFFECTIVE_LATEST_CHANGE = 'Y'
	AND PAAM.PRIMARY_FLAG = 'Y'
	AND HAP.POSITION_ID(+) = PAAM.POSITION_ID
	AND HAOUF.ORGANIZATION_ID = PAAM.LEGAL_ENTITY_ID 
	AND HAOUF.ORGANIZATION_ID = HOUCF.ORGANIZATION_ID 
	AND HAOUF.EFFECTIVE_START_DATE BETWEEN HOUCF.EFFECTIVE_START_DATE AND HOUCF.EFFECTIVE_END_DATE
	AND HOUCF.CLASSIFICATION_CODE = 'HCM_LEMP'
	AND HPB.DOCUMENT_TYPE_ID = HDTL.DOCUMENT_TYPE_ID
	AND HDTL.DOCUMENT_TYPE = 'Digital signatory Masters'
	AND HPB.DOCUMENTS_OF_RECORD_ID = FAD.PK1_VALUE
	AND FAD.DOCUMENT_ID = FDT.DOCUMENT_ID
	AND FDT.LANGUAGE = 'US'
	AND FAD.ENTITY_NAME = 'HR_DOCUMENTS_OF_RECORD'
	AND PPNF.NAME_TYPE = 'GLOBAL'
	AND TRUNC(SYSDATE) BETWEEN PAPF.EFFECTIVE_START_DATE AND PAPF.EFFECTIVE_END_DATE
	)APPROVAL


	WHERE
	1=1
			AND PPNF.PERSON_ID = PAPF.PERSON_ID
			AND PAPF.PERSON_ID = PAAM.PERSON_ID
			AND PAAM.PERSON_ID = LST.PERSON_ID
			AND PAAM.LOCATION_ID =PL.LOCATION_ID(+)
			AND PPNF.NAME_TYPE IN 'GLOBAL'
			AND PAAM.PRIMARY_ASSIGNMENT_FLAG = 'Y'
			AND PAAM.ASSIGNMENT_TYPE = 'E'
			AND PAAM.EFFECTIVE_LATEST_CHANGE = 'Y'
			AND PAAM.PERIOD_OF_SERVICE_ID = PPOS.PERIOD_OF_SERVICE_ID
			AND PPOS.NOTIFIED_TERMINATION_DATE IS NOT NULL
			AND TRUNC(SYSDATE) BETWEEN PAPF.EFFECTIVE_START_DATE AND PAPF.EFFECTIVE_END_DATE
			AND TRUNC(SYSDATE) BETWEEN PAAM.EFFECTIVE_START_DATE AND PAAM.EFFECTIVE_END_DATE
			--AND HAOUF.ORGANIZATION_ID = PAAM.LEGAL_ENTITY_ID 
			--AND HAOUF.ORGANIZATION_ID = HOUCF.ORGANIZATION_ID 
			--AND HAOUF.EFFECTIVE_START_DATE BETWEEN HOUCF.EFFECTIVE_START_DATE AND HOUCF.EFFECTIVE_END_DATE
			--AND HOUCF.CLASSIFICATION_CODE = 'HCM_LEMP'
			AND UPPER(HAOUF.NAME) = APPROVAL.LEGAL_ENTITY
			AND HAOUFB1.ORGANIZATION_ID = PAAM.BUSINESS_UNIT_ID
	        AND HAOUFB1.ORGANIZATION_ID = HOUCFB1.ORGANIZATION_ID 
	        AND HOUCFB1.CLASSIFICATION_CODE = 'FUN_BUSINESS_UNIT'
	        AND TRUNC(SYSDATE) BETWEEN HAOUFB1.EFFECTIVE_START_DATE AND HAOUFB1.EFFECTIVE_END_DATE
	        AND TRUNC(SYSDATE) BETWEEN HOUCFB1.EFFECTIVE_START_DATE AND HOUCFB1.EFFECTIVE_END_DATE
			AND XLE.NAME = NVL(:P_LEGAL_ENTITY,XLE.NAME)
			AND PAAM.LEGAL_ENTITY_ID = HLE.ORGANIZATION_ID
			AND HLE.LEGAL_ENTITY_ID = XLE.LEGAL_ENTITY_ID
			AND HAOUFB1.NAME = NVL(:P_BUSINESS_UNIT,HAOUFB1.NAME)
			AND PAAM.ACTION_CODE IN ('TERMINATION', 'RESIGNATION','INVOLUNTARY_TERMINATION')
			AND PAPF.PERSON_NUMBER =NVL(:P_PERSON_NUMBER,PAPF.PERSON_NUMBER)
			AND PPNF.DISPLAY_NAME = NVL(:P_PERSON_NAME,PPNF.DISPLAY_NAME)
	ORDER BY
	EMPLOYEE_NUMBER
